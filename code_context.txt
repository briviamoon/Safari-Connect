// File: Backend/captive/CaptivePortalAPI.py
import random, socket, platform, uuid, logging, requests, jwt, subprocess, sys, os
# sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '../../')))

from fastapi import FastAPI, HTTPException, Depends
from fastapi.middleware.cors import CORSMiddleware
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import Session
from datetime import datetime, timedelta, timezone
from Backend.Payment.FastAPI import MPESAPayment
from typing import Optional
from Backend.database.dataBase import get_db, Subscription, User, OTP
import africastalking

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # Adjust as per your needs
    allow_credentials=True,
    allow_methods=["*"],  # This allows all HTTP methods
    allow_headers=["*"],  # This allows all headers
)

S_KEY = "93f2d9b13fe90325b803bf2e8f9a66d205f3ff671990ac11423183d334d86691"


# Africa's Talking SMS configuration
africastalking.initialize(
    username='sandbox',
    api_key='atsk_2c126971a075f8c3ed0dbab580d1e4cb7959577587717d23e5fca0b6387104f4e7079690'
)
sms = africastalking.SMS

##########################################################################################


#Get Client MAC ADDRESS
from fastapi import Request

@app.get("/mac-address")
async def get_mac_address(request: Request):
    # Try to retrieve the MAC address based on network setup; this might vary
    try:
        client_ip = request.client.host
        logging.info("ttempting to retreive MAC fro IP: {client_ip}")
        mac_address = get_mac_address(client_ip)
    
        if mac_address:
            return {
                "status": "success",
                "mac_address": mac_address,
                "client_ip": client_ip
            }
        else:
            return {
                "status": "error",
                "message": "MAC address could not be retreived",
                "client_ip": client_ip
            }
    except Exception as e:
        logging.error(f"Error in MAC address endpoint: {e}")
        return {
            "status": "error",
            "message": "An Unexpected error ocured",
            "client_ip": client_ip
        }
    

######################################


# Routes
@app.post("/register")
async def register_user(phone_number: str, mac_address: str, db: Session = Depends(get_db)):
    user = User(phone_number=phone_number, mac_address=mac_address)
    db.add(user)
    db.commit()
    
    # Generate and send OTP
    otp_code = generate_otp()
    print(f"OTP: {otp_code}")
    store_otp(db, phone_number, otp_code)
    send_otp_sms(phone_number, otp_code)
    
    return {"message": "Registration initiated"}


#######################################

# Endpointto verify OTP
@app.post("/verify-otp")
async def verify_otp(phone_number: str, otp_code: str, db: Session = Depends(get_db)):
    #check is OTP is valid and not used
    otp = db.query(OTP).filter(
        OTP.phone_number == phone_number,
        OTP.otp_code == otp_code,
        OTP.is_used == False
    ).first()
    
    if not otp:
        raise HTTPException(status_code=400, detail="Invalid OTP")
    
    #Then Mark It as Used
    otp.is_used = True
    db.commit()
    
    # Check if the user is registered
    user = db.query(User).filter(User.phone_number == phone_number).first()
    if not user:
        raise HTTPException(status_code=404, detail="User not registered")
    
    #check for an active subscripiton.
    active_subscription = db.query(Subscription).filter(
        Subscription.user_id == user.id,
        Subscription.is_active == True,
        Subscription.end_time > datetime.now(timezone.utc)
    ).first()

    #if there's an active subscription, Generate a token leading to the countdown to the end of their session.
    if active_subscription:
        time_left = active_subscription.endtime - datetime.now(timezone.utc)
        
        session_data = {
            "sub": user.phone_number,
            "message": "Hey, you enjoing the Internet?",
            "subscription_actve": True,
            "time_left": time_left.total_seconds(),
            "plan_type": active_subscription.plan_type,
            "user_id":user.id
        }
        token = create_access_token(session_data)
        return {"token": token, "message": "Well, Your Session Is still active..."}
    
    # if there are no active subscriptions
    else:
        access_data = {
            "sub": user.phone_number,
            "message": "Hello, Welcome back!",
            "subscription_active": False,
            "user_id": user.id
        }
        token = create_access_token(access_data)
        return {"token": token, "message": "No active subscription. Pleade select a plan"}

#########################################################

# Endpoint for Subscription Creation
@app.post("/subscribe")
async def create_subscription(
    user_id: int,
    plan_type: str,
    db: Session = Depends(get_db)
):
    # Plan configurations
    plans = {
        "1hr": {"amount": 10, "duration": timedelta(hours=1)},
        "2hrs": {"amount": 25, "duration": timedelta(hours=2)},
        "5hrs": {"amount": 65, "duration": timedelta(hours=5)},
        "monthly": {"amount": 500, "duration": timedelta(days=30)}
    }
    
    if plan_type not in plans:
        raise HTTPException(status_code=400, detail="Invalid plan type")
    
    plan = plans[plan_type]
    subscription = Subscription(
        user_id=user_id,
        plan_type=plan_type,
        amount=plan["amount"],
        start_time=datetime.now(timezone.utc),
        end_time=datetime.now(timezone.utc) + plan["duration"]
    )
    
    db.add(subscription)
    db.commit()
    
    # Initiate M-Pesa payment
    response = initiate_mpesa_payment(subscription.id, plan["amount"], db)
    
    return {"message": "Subscription initiated, payment pending", "mpesa_response": response}

###############################

# RETURNING USERS #

@app.post("/login")
async def login_user(phone_number: str, db: Session = Depends(get_db)):
    # Check if the user is registered
    user = db.query(User).filter(User.phone_number == phone_number).first()
    if not user:
        raise HTTPException(status_code=404, detail="User not registered")

    # Generate and store OTP
    otp_code = generate_otp()
    store_otp(db, phone_number, otp_code)
    send_otp_sms(phone_number, otp_code)
    return {"message": "OTP sent to your phone"}

#################################################################################################

#### FUNCTIONS ####

# Generate 6 figure OTP
def generate_otp():
    # Generate 6-digit OTP
    import random
    return str(random.randint(100000, 999999))


#Store OTP in Database
def store_otp(db: Session, phone_number: str, otp_code: str):
    otp = OTP(phone_number=phone_number, otp_code=otp_code, is_used=False, created_at=datetime.now(timezone.utc))
    db.add(otp)
    db.commit()


#Send OTP SMS
def send_otp_sms(phone_number: str, otp_code: str):
    message = f"Your OTP code is: {otp_code}"
    try:
        response = sms.send(message, [phone_number])
        return response
    except Exception as e:
        raise HTTPException(status_code=500, detail="Failed to send SMS")


#Create an Access Token
def create_access_token(phone_number: str):
    to_encode = {"sub": phone_number}
    encoded_jwt = jwt.encode(to_encode, S_KEY, algorithm="HS256")
    return encoded_jwt


#Initialize Mpesa Payment
def initiate_mpesa_payment(subscription_id: int, amount: float, db: Session):
    # Retrieve the user's phone number from the database
    subscription = db.query(Subscription).filter(Subscription.id == subscription_id).first()
    user = db.query(User).filter(User.id == subscription.user_id).first()
    
    if not user:
        raise HTTPException(status_code=404, detail="user not found")
    
    phone_number = user.phone_number
    mpesa_payment = MPESAPayment()
    
    try:
        # STK PUSH INITIATE
        response = mpesa_payment.initiate_stk_push(
            phone_number=phone_number,
            amount=amount,
            reference=str(subscription_id) # unique to match with callback
        )
        return response
    except Exception as e:
        print(f"Error initializing payment: {e}")
        raise HTTPException(status_code=500, detail="M-Pesa payment initiaizaion failed")


def get_mac_from_ip(ip_address):
    """
    Attempt to retrieve MAC address for a given IP address using multiple methods.
    
    Args:
        ip_address (str): IP address to find MAC for
    
    Returns:
        str: MAC address if found, None otherwise
    """
    try:
        # Method 1: Use system-specific ARP commands
        os_system = platform.system().lower()
        
        if os_system == 'windows':
            try:
                # Windows ARP command
                result = subprocess.run(['arp', '-a', ip_address], 
                                        capture_output=True, 
                                        text=True, 
                                        timeout=5)
                # Parse ARP output to extract MAC
                for line in result.stdout.split('\n'):
                    if ip_address in line:
                        # Extract MAC address (typically in format xx-xx-xx-xx-xx-xx)
                        mac = line.split()[-1].replace('-', ':')
                        if mac and len(mac.split(':')) == 6:
                            return mac
            except Exception as e:
                logging.error(f"Windows ARP lookup failed: {e}")
        
        elif os_system in ['linux', 'darwin']:  # Linux or macOS
            try:
                # Linux/macOS ARP command
                result = subprocess.run(['arp', '-n', ip_address], 
                                        capture_output=True, 
                                        text=True, 
                                        timeout=5)
                # Parse ARP output to extract MAC
                for line in result.stdout.split('\n'):
                    if ip_address in line:
                        # Extract MAC address (typically in format xx:xx:xx:xx:xx:xx)
                        parts = line.split()
                        mac = parts[2] if len(parts) > 2 else None
                        if mac and len(mac.split(':')) == 6:
                            return mac
            except Exception as e:
                logging.error(f"Linux/macOS ARP lookup failed: {e}")
        
        # Method 2: Fallback to UUID (if above methods fail)
        # This will return a pseudo-MAC based on the system's UUID
        if ip_address == '127.0.0.1' or ip_address == '::1':
            return str(uuid.getnode())
        
        # Additional fallback: Try socket method
        try:
            hostname = socket.gethostbyaddr(ip_address)[0]
            # Attempt to get MAC via hostname (not reliable for remote IPs)
            mac = ':'.join(['{:02x}'.format((uuid.getnode() >> elements) & 0xff) 
                            for elements in range(0,2*6,2)][::-1])
            return mac
        except Exception as e:
            logging.error(f"Hostname MAC lookup failed: {e}")
        
        return None
    
    except Exception as e:
        logging.error(f"Unexpected error in get_mac_from_ip: {e}")
        return None



// File: Backend/captive/__pycache__/CaptivePortalAPI.cpython-312.pyc
Ë
    rI%gZ,  ã                   ó  — d dl Z d dlZd dlZd dlZd dlZd dlZd dlZd dlZd dlZd dl	Z	d dl
mZmZmZ d dlmZ d dlmZ d dlmZ d dlmZmZmZ d dlmZ d dlmZ d d	lmZmZmZmZ d dl Z  e«       Z!e!jE                  ed
gdd
gd
g¬«       dZ# e jH                  dd¬«       e jJ                  Z&d dl
m'Z' e!jQ                  d«      de'fd„«       Z)e!jU                  d«       ee«      fde+de+defd„«       Z,e!jU                  d«       ee«      fde+de+defd„«       Z-e!jU                  d«       ee«      fde.de+defd „«       Z/e!jU                  d!«       ee«      fde+defd"„«       Z0d#„ Z1dede+de+fd$„Z2de+de+fd%„Z3de+fd&„Z4d'e.d(e5defd)„Z6d*„ Z7y)+é    N)ÚFastAPIÚHTTPExceptionÚDepends)ÚCORSMiddleware)Údeclarative_base)ÚSession)ÚdatetimeÚ	timedeltaÚtimezone)ÚMPESAPayment)ÚOptional)Úget_dbÚSubscriptionÚUserÚOTPÚ*T)Úallow_originsÚallow_credentialsÚallow_methodsÚallow_headersÚ@93f2d9b13fe90325b803bf2e8f9a66d205f3ff671990ac11423183d334d86691ÚsandboxÚMatsk_2c126971a075f8c3ed0dbab580d1e4cb7959577587717d23e5fca0b6387104f4e7079690)ÚusernameÚapi_key)ÚRequestz/mac-addressÚrequestc              ƒ   óü   K  — 	 | j                   j                  }t        j                  d«       t	        |«      }|rd||dœS dd|dœS # t
        $ r(}t        j                  d|› «       dddœcY d }~S d }~ww xY w­w)	Nz-ttempting to retreive MAC fro IP: {client_ip}Úsuccess)ÚstatusÚmac_addressÚ	client_ipÚerrorz"MAC address could not be retreived)r    Úmessager"   zError in MAC address endpoint: zAn Unexpected error ocured)ÚclientÚhostÚloggingÚinfoÚget_mac_addressÚ	Exceptionr#   )r   r"   r!   Úes       úT/home/moon/Desktop/Safari Connect/Safari-Connect/Backend/captive/CaptivePortalAPI.pyr)   r)   (   s”   è ø€ ğ
Ø—N‘N×'Ñ'ˆ	Ü‰ĞDÔEÜ% iÓ0ˆáà#Ø*Ø&ñğ ğ "Ø?Ø&ñğ øô
 ò 
Ü‰Ğ7¸°sĞ;Ô<àØ3Ø"ñ
õ 	
ûğ
üs@   ‚A<„=A ÁA<ÁA ÁA<Á	A9ÁA4Á.A9Á/A<Á4A9Á9A<z	/registerÚphone_numberr!   Údbc              ƒ   óĞ   K  — t        | |¬«      }|j                  |«       |j                  «        t        «       }t	        d|› «       t        || |«       t        | |«       ddiS ­w)N)r-   r!   zOTP: r$   zRegistration initiated)r   ÚaddÚcommitÚgenerate_otpÚprintÚ	store_otpÚsend_otp_sms)r-   r!   r.   ÚuserÚotp_codes        r,   Úregister_userr8   I   s`   è ø€ ä˜\°{ÔC€DØ‡FFˆ4„LØ‡II„Kô ‹~€HÜ	ˆE(Ğ
ÔÜˆb, Ô)Ü˜xÔ(àĞ/Ğ0Ğ0ùs   ‚A$A&z/verify-otpr7   c              ƒ   ó0  K  — |j                  t        «      j                  t        j                  | k(  t        j                  |k(  t        j
                  dk(  «      j                  «       }|st        dd¬«      ‚d|_        |j                  «        |j                  t        «      j                  t        j                  | k(  «      j                  «       }|st        dd¬«      ‚|j                  t        «      j                  t        j                  |j                  k(  t        j                  dk(  t        j                  t        j                   t"        j$                  «      kD  «      j                  «       }|ru|j&                  t        j                   t"        j$                  «      z
  }|j                  dd|j)                  «       |j*                  |j                  d	œ}t-        |«      }|d
dœS |j                  dd|j                  dœ}	t-        |	«      }|ddœS ­w)NFé  zInvalid OTP©Ústatus_codeÚdetailTé”  úUser not registeredzHey, you enjoing the Internet?)Úsubr$   Úsubscription_actveÚ	time_leftÚ	plan_typeÚuser_idz%Well, Your Session Is still active...)Útokenr$   zHello, Welcome back!)r@   r$   Úsubscription_activerD   z,No active subscription. Pleade select a plan)Úqueryr   Úfilterr-   r7   Úis_usedÚfirstr   r1   r   r   rD   ÚidÚ	is_activeÚend_timer	   Únowr   ÚutcÚendtimeÚtotal_secondsrC   Úcreate_access_token)
r-   r7   r.   Úotpr6   Úactive_subscriptionrB   Úsession_datarE   Úaccess_datas
             r,   Ú
verify_otprW   [   s¼  è ø€ ğ (‰(”3‹-×
Ñ
Ü×Ñ˜LÑ(Ü‰˜Ñ Ü‰uÑó÷ eƒgğ	 ñ Ü¨°MÔBĞBğ €C„KØ‡II„Kğ 8‰8”D‹>× Ñ ¤×!2Ñ!2°lÑ!BÓC×IÑIÓK€DÙÜ¨Ğ4IÔJĞJğ Ÿ(™(¤<Ó0×7Ñ7Ü×Ñ §¡Ñ'Ü×Ñ $Ñ&Ü×Ñ¤§¡¬X¯\©\Ó :Ñ:ó÷ eƒgğ	 ñ Ø'×/Ñ/´(·,±,¼x¿|¹|Ó2LÑLˆ	ğ ×$Ñ$Ø7Ø"&Ø"×0Ñ0Ó2Ø,×6Ñ6Ø—g‘gñ
ˆô $ LÓ1ˆØĞ+RÑSĞSğ
 ×$Ñ$Ø-Ø#(Ø—w‘wñ	
ˆô $ KÓ0ˆØĞ+YÑZĞZùs   ‚HHz
/subscriberD   rC   c           	   ƒ   óâ  K  — dt        d¬«      dœdt        d¬«      dœdt        d¬«      dœd	t        d
¬«      dœdœ}||vrt        dd¬«      ‚||   }t        | ||d   t        j                  t
        j                  «      t        j                  t
        j                  «      |d   z   ¬«      }|j                  |«       |j                  «        t        |j                  |d   |«      }d|dœS ­w)Né
   é   )Úhours)ÚamountÚdurationé   é   éA   é   éô  é   )Údays)Ú1hrÚ2hrsÚ5hrsÚmonthlyr:   zInvalid plan typer;   r\   r]   )rD   rC   r\   Ú
start_timerM   z'Subscription initiated, payment pending)r$   Úmpesa_response)r
   r   r   r	   rN   r   rO   r0   r1   Úinitiate_mpesa_paymentrK   )rD   rC   r.   ÚplansÚplanÚsubscriptionÚresponses          r,   Úcreate_subscriptionrp   ”   sá   è ø€ ğ ¬)¸!Ô*<Ñ=Ø¬9¸1Ô+=Ñ>Ø¬9¸1Ô+=Ñ>Ø!¬y¸bÔ/AÑBñ	€Eğ ˜ÑÜ¨Ğ4GÔHĞHàÑ€DÜØØØH‰~Ü—<‘<¤§¡Ó-Ü—‘œhŸl™lÓ+¨d°:Ñ.>Ñ>ô€Lğ ‡FFˆ<ÔØ‡II„Kô & l§o¡o°t¸H±~ÀrÓJ€Hà@ĞT\Ñ]Ğ]ùs   ‚C-C/z/loginc              ƒ   óü   K  — |j                  t        «      j                  t        j                  | k(  «      j	                  «       }|st        dd¬«      ‚t        «       }t        || |«       t        | |«       ddiS ­w)Nr>   r?   r;   r$   zOTP sent to your phone)	rG   r   rH   r-   rJ   r   r2   r4   r5   )r-   r.   r6   r7   s       r,   Ú
login_userrr   º   sp   è ø€ ğ 8‰8”D‹>× Ñ ¤×!2Ñ!2°lÑ!BÓC×IÑIÓK€DÙÜ¨Ğ4IÔJĞJô ‹~€HÜˆb, Ô)Ü˜xÔ(ØĞ/Ğ0Ğ0ùs   ‚A:A<c                  óB   — dd l } t         | j                  dd«      «      S )Nr   i † i?B )ÚrandomÚstrÚrandint)rt   s    r,   r2   r2   Ì   s   € ãÜˆ~ˆv~‰~˜f fÓ-Ó.Ğ.ó    c                 ó¦   — t        ||dt        j                  t        j                  «      ¬«      }| j                  |«       | j                  «        y )NF)r-   r7   rI   Ú
created_at)r   r	   rN   r   rO   r0   r1   )r.   r-   r7   rS   s       r,   r4   r4   Ó   s9   € Ü
˜<°(ÀEÔV^×VbÑVbÔck×coÑcoÓVpÔ
q€CØ‡FFˆ3„KØ‡II…Krw   c                 ó|   — d|› }	 t         j                  || g«      }|S # t        $ r}t        dd¬«      ‚d }~ww xY w)NzYour OTP code is: rb   zFailed to send SMSr;   )ÚsmsÚsendr*   r   )r-   r7   r$   ro   r+   s        r,   r5   r5   Ú   sK   € Ø" 8 *Ğ-€GğJÜ—8‘8˜G l ^Ó4ˆØˆøÜò JÜ¨Ğ4HÔIĞIûğJús   ‡   	;©6¶;c                 óF   — d| i}t        j                  |t        d¬«      }|S )Nr@   ÚHS256)Ú	algorithm)ÚjwtÚencodeÚS_KEY)r-   Ú	to_encodeÚencoded_jwts      r,   rR   rR   ä   s$   € Ø˜Ğ%€IÜ—*‘*˜Y¬¸ÔA€KØĞrw   Úsubscription_idr\   c                 ó  — |j                  t        «      j                  t        j                  | k(  «      j	                  «       }|j                  t
        «      j                  t
        j                  |j                  k(  «      j	                  «       }|st        dd¬«      ‚|j                  }t        «       }	 |j                  ||t        | «      ¬«      }|S # t        $ r }t        d|› «       t        dd¬«      ‚d }~ww xY w)Nr>   zuser not foundr;   )r-   r\   Ú	referencezError initializing payment: rb   z"M-Pesa payment initiaizaion failed)rG   r   rH   rK   rJ   r   rD   r   r-   r   Úinitiate_stk_pushru   r*   r3   )	r…   r\   r.   rn   r6   r-   Úmpesa_paymentro   r+   s	            r,   rk   rk   ë   sà   € à—8‘8œLÓ)×0Ñ0´·±ÀOÑ1SÓT×ZÑZÓ\€LØ8‰8”D‹>× Ñ ¤§¡¨L×,@Ñ,@Ñ!@ÓA×GÑGÓI€DáÜ¨Ğ4DÔEĞEà×$Ñ$€LÜ “N€Mğ
Zà ×2Ñ2Ø%ØÜ˜/Ó*ğ 3ó 
ˆğ
 ˆøÜò ZÜĞ,¨Q¨CĞ0Ô1Ü¨Ğ4XÔYĞYûğZús   Â7C Ã	C?ÃC:Ã:C?c           	      ó2  — 	 t        j                  «       j                  «       }|dk(  rŠ	 t        j                  dd| gddd¬«      }|j
                  j                  d«      D ]N  }| |v sŒ|j                  «       d   j                  d	d
«      }|sŒ.t        |j                  d
«      «      dk(  sŒL|c S  n|dv rŒ	 t        j                  dd| gddd¬«      }|j
                  j                  d«      D ]P  }| |v sŒ|j                  «       }t        |«      dkD  r|d   nd}|sŒ0t        |j                  d
«      «      dk(  sŒN|c S  	 | dk(  s| dk(  rt        t        j                  «       «      S 	 t        j                   | «      d   }d
j#                  t%        ddd«      D cg c]+  }dj'                  t        j                  «       |z	  dz  «      ‘Œ- c}ddd…   «      }|S # t        $ r"}t        j                  d|› «       Y d}~Œ¿d}~ww xY w# t        $ r"}t        j                  d|› «       Y d}~Œíd}~ww xY wc c}w # t        $ r"}t        j                  d|› «       Y d}~yd}~ww xY w# t        $ r"}t        j                  d|› «       Y d}~yd}~ww xY w)zà
    Attempt to retrieve MAC address for a given IP address using multiple methods.
    
    Args:
        ip_address (str): IP address to find MAC for
    
    Returns:
        str: MAC address if found, None otherwise
    ÚwindowsÚarpz-aTra   )Úcapture_outputÚtextÚtimeoutú
éÿÿÿÿú-ú:é   zWindows ARP lookup failed: N)ÚlinuxÚdarwinz-nr_   zLinux/macOS ARP lookup failed: z	127.0.0.1z::1r   é   z{:02x}éÿ   zHostname MAC lookup failed: z%Unexpected error in get_mac_from_ip: )ÚplatformÚsystemÚlowerÚ
subprocessÚrunÚstdoutÚsplitÚreplaceÚlenr*   r'   r#   ru   ÚuuidÚgetnodeÚsocketÚgethostbyaddrÚjoinÚrangeÚformat)	Ú
ip_addressÚ	os_systemÚresultÚlineÚmacr+   ÚpartsÚhostnameÚelementss	            r,   Úget_mac_from_ipr±     s‚  € ğ:ä—O‘OÓ%×+Ñ+Ó-ˆ	à˜	Ò!ğAä#Ÿ™¨°°jĞ(AØ7;Ø-1Ø01ô3ğ
 #ŸM™M×/Ñ/°Ó5ò 'DØ! TÒ)à"Ÿj™j›l¨2Ñ.×6Ñ6°s¸CÓ@˜Ú¤3 s§y¡y°£~Ó#6¸!Ó#;Ø#&šJñ'ğ Ğ-Ñ-ğEä#Ÿ™¨°°jĞ(AØ7;Ø-1Ø01ô3ğ
 #ŸM™M×/Ñ/°Ó5ò 'DØ! TÒ)à $§
¡
£˜Ü*-¨e«*°qª.˜e Ašh¸d˜Ú¤3 s§y¡y°£~Ó#6¸!Ó#;Ø#&šJñ'ğ ˜Ò$¨
°eÒ(;Ü”t—|‘|“~Ó&Ğ&ğ	>Ü×+Ñ+¨JÓ7¸Ñ:ˆHà—(‘(Ü,1°!°C¸«Nö<Ø (ğ %ŸO™O¬T¯\©\«^¸xÑ-GÈ4Ñ,OÕPò <Ù<@¸b¸DñBó CˆCàˆJøôA ò AÜ—‘Ğ ;¸A¸3Ğ?×@Ñ@ûğAûô$ ò EÜ—‘Ğ ?À¸sĞC×DÑDûğEüò<øô ò 	>ÜM‰MĞ8¸¸Ğ<×=Ğ=àûğ	>ûô
 ò Ü‰Ğ=¸a¸SĞAÔBÜûğúsĞ   ‚'I+ ª>G Á)%G ÂG Â-G Â1G Â2I+ Â8>H
 Ã7'H
 ÄH
 Ä=H
 ÅH
 Å'I+ Å+2H= Æ0H8ÇH= Ç	HÇ%HÇ=I+ ÈHÈI+ È
	H5ÈH0È+I+ È0H5È5I+ È8H= È=	I(ÉI#ÉI+ É#I(É(I+ É+	JÉ4JÊJ)8rt   r¤   r™   r¢   r'   Úrequestsr€   rœ   ÚsysÚosÚfastapir   r   r   Úfastapi.middleware.corsr   Úsqlalchemy.ext.declarativer   Úsqlalchemy.ormr   r	   r
   r   ÚBackend.Payment.FastAPIr   Útypingr   ÚBackend.database.dataBaser   r   r   r   ÚafricastalkingÚappÚadd_middlewarer‚   Ú
initializeÚSMSr{   r   Úgetr)   Úpostru   r8   rW   Úintrp   rr   r2   r4   r5   rR   Úfloatrk   r±   © rw   r,   ú<module>rÆ      s  ğß R× R× R× R× R÷ 4Ñ 3İ 2İ 7İ "ß 2Ñ 2İ 0İ ß EÓ EÛ áƒi€à × Ñ ØØ%ØØ%Ø%ğ ô ğ 	K€ğ €× Ñ ØØ[õğ ×Ñ€õ à‡ˆÓğ
 7ò 
ó ğ
ğ@ ‡ˆ+ÓÙKRĞSYË?ñ 1 cğ 1¸ğ 1Àò 1ó ğ1ğ" ‡ˆ-ÓÙELÈVÃ_ñ 3[ 3ğ 3[°#ğ 3[¸7ò 3[ó ğ3[ğp ‡ˆ,Óñ ˜&“/ñ^Øğ^àğ^ğ 	ò^ó ğ^ğJ ‡ˆ(ÓÙ6=¸f³oñ 
1 3ğ 
1¨Gò 
1ó ğ
1ò"/ğ'ğ ¨ğ ¸ó ğJ˜sğ J¨có Jğ có ğZ¨Cğ Z¸ğ ZÀGó Zó0Drw   


// File: Backend/captive/SKey.py
import secrets

# Generate a 32-byte hex key for strong security
secret_key = secrets.token_hex(32)
print(secret_key)



// File: Backend/database/dataBase.py
from sqlalchemy import create_engine, Column, Integer, String, Float, DateTime, Boolean, inspect
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker, Session
from datetime import datetime, timezone

Base = declarative_base()

# Database Models
class User(Base):
    __tablename__ = "users"
    id = Column(Integer, primary_key=True, index=True)
    phone_number = Column(String, unique=True, index=True)
    mac_address = Column(String)
    created_at = Column(DateTime, default=datetime.now(timezone.utc))
    is_active = Column(Boolean, default=True)

class Subscription(Base):
    __tablename__ = "subscriptions"
    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer)
    plan_type = Column(String)  # '1hr', '2hrs', '5hrs', 'monthly'
    amount = Column(Float)
    start_time = Column(DateTime)
    end_time = Column(DateTime)
    is_active = Column(Boolean, default=True)

class OTP(Base):
    __tablename__ = "otps"
    id = Column(Integer, primary_key=True, index=True)
    phone_number = Column(String)
    otp_code = Column(String)
    created_at = Column(DateTime, default=datetime.now(timezone.utc))
    is_used = Column(Boolean, default=False)

class PaymentRecord(Base):
    __tablename__ = "payment_records"
    id = Column(Integer, primary_key=True, index=True)
    checkout_id = Column(String, unique=True, index=True)  # The M-Pesa transaction ID
    subscription_id = Column(Integer)  # Links to the Subscription table
    status = Column(String, default="Pending")  # Payment status: "Pending", "Successful", or "Failed"
    created_at = Column(DateTime, default=datetime.now(timezone.utc))


# Database connection
DATABASE_URL = "postgresql://safariconnect:1Amodung%40%21.@192.168.0.102:5432/captive_portal"
engine = create_engine(DATABASE_URL)
SessionLocal = sessionmaker(autocommit=False, autoload=True, bind=engine)

#Ensuring the tables are created only once
inspector = inspect(engine)
if not inspector.get_table_names():  # Check if tables already exist
    print("Setting up database tables...")
    Base.metadata.create_all(bind=engine)
    print("Tables created.")

# Dependencies
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


// File: Backend/database/__pycache__/dataBase.cpython-312.pyc
Ë
    9%gç  ã                   óv  — d dl mZmZmZmZmZmZmZmZ d dl	m
Z
 d dlmZmZ d dlmZmZ  e
«       Z G d„ de«      Z G d„ de«      Z G d	„ d
e«      Z G d„ de«      ZdZ ee«      Z edde¬«      Z ee«      Zej3                  «       s, ed«       ej6                  j9                  e¬«        ed«       d„ Zy)é    )Úcreate_engineÚColumnÚIntegerÚStringÚFloatÚDateTimeÚBooleanÚinspect)Údeclarative_base)ÚsessionmakerÚSession)ÚdatetimeÚtimezonec                   ó¨   — e Zd ZdZ eedd¬«      Z eedd¬«      Z ee«      Z	 ee
 ej                  ej                  «      ¬«      Z eed¬«      Zy)ÚUserÚusersT©Úprimary_keyÚindex©Úuniquer   ©ÚdefaultN)Ú__name__Ú
__module__Ú__qualname__Ú__tablename__r   r   Úidr   Úphone_numberÚmac_addressr   r   Únowr   ÚutcÚ
created_atr	   Ú	is_active© ó    úM/home/moon/Desktop/Safari Connect/Safari-Connect/Backend/database/dataBase.pyr   r   	   sS   „ Ø€MÙ	 T°Ô	6€BÙ˜&¨°TÔ:€LÙ˜“.€KÙ˜¨,¨(¯,©,°x·|±|Ó*DÔE€JÙw¨Ô-Ir&   r   c                   óŠ   — e Zd ZdZ eedd¬«      Z ee«      Z ee«      Z	 ee
«      Z ee«      Z ee«      Z eed¬«      Zy)ÚSubscriptionÚsubscriptionsTr   r   N)r   r   r   r   r   r   r   Úuser_idr   Ú	plan_typer   Úamountr   Ú
start_timeÚend_timer	   r$   r%   r&   r'   r)   r)      sP   „ Ø#€MÙ	 T°Ô	6€BÙW‹o€GÙv“€IÙE‹]€FÙ˜Ó!€JÙhÓ€HÙw¨Ô-Ir&   r)   c                   ó¢   — e Zd ZdZ eedd¬«      Z ee«      Z ee«      Z	 ee
 ej                  ej                  «      ¬«      Z eed¬«      Zy)ÚOTPÚotpsTr   r   FN)r   r   r   r   r   r   r   r   r   Úotp_coder   r   r!   r   r"   r#   r	   Úis_usedr%   r&   r'   r1   r1      sN   „ Ø€MÙ	 T°Ô	6€BÙ˜&“>€LÙf‹~€HÙ˜¨,¨(¯,©,°x·|±|Ó*DÔE€JÙW eÔ,Gr&   r1   c                   ó¨   — e Zd ZdZ eedd¬«      Z eedd¬«      Z ee«      Z	 eed¬«      Z
 ee ej                  ej                  «      ¬«      Zy)ÚPaymentRecordÚpayment_recordsTr   r   ÚPendingr   N)r   r   r   r   r   r   r   r   Úcheckout_idÚsubscription_idÚstatusr   r   r!   r   r"   r#   r%   r&   r'   r6   r6   #   sS   „ Ø%€MÙ	 T°Ô	6€BÙ˜¨°DÔ9€KÙ˜W“o€OÙF IÔ.€FÙ˜¨,¨(¯,©,°x·|±|Ó*DÔEJr&   r6   zLpostgresql://safariconnect:1Amodung%40%21.@192.168.0.102:5432/captive_portalFT)Ú
autocommitÚautoloadÚbindzSetting up database tables...)r>   zTables created.c               #   ót   K  — t        «       } 	 | –— | j                  «        y # | j                  «        w xY w­w)N)ÚSessionLocalÚclose)Údbs    r'   Úget_dbrC   9   s)   è ø€ Ü	‹€BğØŠà
‰
øˆ‰
üs   ‚8# ’8£5µ8N)Ú
sqlalchemyr   r   r   r   r   r   r	   r
   Úsqlalchemy.ext.declarativer   Úsqlalchemy.ormr   r   r   r   ÚBaser   r)   r1   r6   ÚDATABASE_URLÚenginer@   Ú	inspectorÚget_table_namesÚprintÚmetadataÚ
create_allrC   r%   r&   r'   ú<module>rO      s´   ğß `× `Ó `İ 7ß 0ß 'áÓ€ô.ˆ4ô .ô.4ô .ô-ˆ$ô -ôFDô Fğ ^€Ù	|Ó	$€Ù u°tÀ&ÔI€ñ F‹O€	Ø× Ñ Ô"Ù	Ğ
)Ô*Ø‡MM×Ñ &ĞÔ)Ù	Ğ
Ôór&   


// File: Backend/Payment/FastAPI.py
from fastapi import FastAPI, HTTPException, BackgroundTasks, Depends
from fastapi.middleware.cors import CORSMiddleware
from Backend.database.dataBase import get_db, PaymentRecord, Subscription
from pydantic import BaseModel
from sqlalchemy.orm import Session
import requests
import base64
from datetime import datetime, timedelta
import json

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # Adjust as per your needs
    allow_credentials=True,
    allow_methods=["*"],  # This allows all HTTP methods
    allow_headers=["*"],  # This allows all headers
)

class MPESACredentials:
    CONSUMER_KEY = "O7VPs1yZAADxdI4nszyxI4lAN8IXCX2Glf0gRcNm5SgG5b48"
    CONSUMER_SECRET = "CrKa9Fu9hB65bpNKSF03ZWqCR8QdrHhvGZFjVRSRVM2Jb7ynfx7ctTtJUY0KEhKG"
    PASSKEY = "bfb279f9aa9bdbcf158e97dd71a467cd2e0c893059b10f78e6b72ada1ed2c919"
    BUSINESS_SHORT_CODE = "174379"  # Usually your Paybill number
    CALLBACK_URL = "https://1b61-41-209-3-162.ngrok-free.app"


class MPESAPayment:
    def __init__(self):
        self.access_token = None
        self.access_token_expiry = None
        
    def generate_password(self):
        """Generate the M-Pesa password using the provided passkey"""
        timestamp = datetime.now().strftime('%Y%m%d%H%M%S')
        data_to_encode = f"{MPESACredentials.BUSINESS_SHORT_CODE}{MPESACredentials.PASSKEY}{timestamp}"
        return base64.b64encode(data_to_encode.encode()).decode('utf-8'), timestamp
        
    async def get_access_token(self):
        """Get the access token required to make M-Pesa API calls"""
        if self.access_token and datetime.now() < self.access_token_expiry:
            return self.access_token
            
        credentials = base64.b64encode(
            f"{MPESACredentials.CONSUMER_KEY}:{MPESACredentials.CONSUMER_SECRET}".encode()
        ).decode('utf-8')
        
        response = requests.get(
            "https://sandbox.safaricom.co.ke/oauth/v1/generate?grant_type=client_credentials",
            headers={"Authorization": f"Basic {credentials}"}
        )
        
        if response.status_code != 200:
            raise HTTPException(status_code=400, detail="Failed to get access token")
            
        result = response.json()
        self.access_token = result['access_token']
        # Token expires in 1 hour
        self.access_token_expiry = datetime.now() + timedelta(seconds=3599)
        return self.access_token
        
    async def initiate_stk_push(self, phone_number: str, amount: float, reference: str):
        """Initiate STK push to customer's phone"""
        access_token = await self.get_access_token()
        password, timestamp = self.generate_password()
        
        headers = {
            "Authorization": f"Bearer {access_token}",
            "Content-Type": "application/json",
        }
        
        payload = {
            "BusinessShortCode": MPESACredentials.BUSINESS_SHORT_CODE,
            "Password": password,
            "Timestamp": timestamp,
            "TransactionType": "CustomerPayBillOnline",
            "Amount": int(amount),
            "PartyA": phone_number,
            "PartyB": MPESACredentials.BUSINESS_SHORT_CODE,
            "PhoneNumber": phone_number,
            "CallBackURL": MPESACredentials.CALLBACK_URL,
            "AccountReference": reference,
            "TransactionDesc": f"WiFi Subscription {reference}"
        }
        
        response = requests.post(
            "https://sandbox.safaricom.co.ke/mpesa/stkpush/v1/processrequest",
            json=payload,
            headers=headers
        )
        
        if response.status_code != 200:
            raise HTTPException(status_code=400, detail="Failed to initiate payment")
            
        return response.json()


# FastAPI routes for M-Pesa integration
@app.post("/mpesa/initiate")
async def initiate_payment(
    phone_number: str,
    amount: float,
    subscription_id: int,
    background_tasks: BackgroundTasks
):
    mpesa = MPESAPayment()
    result = await mpesa.initiate_stk_push(
        phone_number=phone_number,
        amount=amount,
        reference=str(subscription_id)
    )
    
    # Store the checkout request ID for verification
    background_tasks.add_task(
        store_checkout_request,
        checkout_id=result['CheckoutRequestID'],
        subscription_id=subscription_id
    )
    
    return {"message": "Payment initiated", "checkout_id": result['CheckoutRequestID']}



@app.post("/mpesa/callback")
async def mpesa_callback(payment_data: dict, db: Session = Depends(get_db)):
    """Handle M-Pesa callback"""
    try:
        # Extract payment details from callback
        result = payment_data['Body']['stkCallback']
        checkout_id = result['CheckoutRequestID']
        
        if result['ResultCode'] == 0:
            # Payment successful
            # Now to Update subscription status
            await activate_subscription(checkout_id, db)
            return {"message": "Payment processed successfully"}
        else:
            # Payment failed
            await mark_payment_failed(checkout_id, db)
            return {"message": "Payment failed"}
            
    except Exception as e:
        raise HTTPException(status_code=400, detail="Invalid callback data")




async def store_checkout_request(checkout_id: str, subscription_id: int, db: Session):
    """When initiating an M-Pesa transaction, you will receive a CheckoutRequestID that serves as a unique identifier.
    Store this ID and subscription_id in the database to verify payment status later."""
    payment_record = PaymentRecord(
        checkout_id=checkout_id,
        subscription_id=subscription_id,
        status="Pending" # initial status
    )
    db.add(payment_record)
    db.commit()



async def activate_subscription(checkout_id: str, db: Session):
    """Activate subscription after successful payment"""
    # Retrieve payment record
    payment_record = db.query(PaymentRecord).filter(PaymentRecord.checkout_id == checkout_id).first()
    
    if payment_record:
        # update the subscription status.
        subscription = db.query(Subscription).filter(Subscription.id == payment_record.subscription_id).first()
        if subscription:
            subscription.is_active = True
            db.commit()
            print("Subscription activated")



async def mark_payment_failed(checkout_id: str, db: Session):
    """This function will mark the subscription as inactive or pending in case of payment failure."""
    # Retrieve the payment record
    payment_record = db.query(PaymentRecord).filter(PaymentRecord.checkout_id == checkout_id).first()
    
    if payment_record:
        # Update the subscription status as failed
        subscription = db.query(Subscription).filter(Subscription.id == payment_record.subscription_id).first()
        if subscription:
            subscription.is_active = False
            db.commit()
            print("Payment failed, subscription inactive")


// File: Backend/Payment/__pycache__/FastAPI.cpython-312.pyc
Ë
    öA%gb  ã            	       ó   — d dl mZmZmZmZ d dlmZ d dlmZm	Z	m
Z
 d dlmZ d dlmZ d dlZd dlZd dlmZmZ d dlZ e«       Zej+                  edgd	dgdg¬
«        G d„ d«      Z G d„ d«      Zej1                  d«      dedededefd„«       Zej1                  d«       ee«      fdedefd„«       Zdededefd„Zdedefd„Z dedefd„Z!y)é    )ÚFastAPIÚHTTPExceptionÚBackgroundTasksÚDepends)ÚCORSMiddleware)Úget_dbÚPaymentRecordÚSubscription)Ú	BaseModel)ÚSessionN)ÚdatetimeÚ	timedeltaÚ*T)Úallow_originsÚallow_credentialsÚallow_methodsÚallow_headersc                   ó    — e Zd ZdZdZdZdZdZy)ÚMPESACredentialsÚ0O7VPs1yZAADxdI4nszyxI4lAN8IXCX2Glf0gRcNm5SgG5b48Ú@CrKa9Fu9hB65bpNKSF03ZWqCR8QdrHhvGZFjVRSRVM2Jb7ynfx7ctTtJUY0KEhKGÚ@bfb279f9aa9bdbcf158e97dd71a467cd2e0c893059b10f78e6b72ada1ed2c919Ú174379z(https://1b61-41-209-3-162.ngrok-free.appN)Ú__name__Ú
__module__Ú__qualname__ÚCONSUMER_KEYÚCONSUMER_SECRETÚPASSKEYÚBUSINESS_SHORT_CODEÚCALLBACK_URL© ó    úK/home/moon/Desktop/Safari Connect/Safari-Connect/Backend/Payment/FastAPI.pyr   r      s   „ ØE€LØX€OØP€GØ"ĞØ=Lr#   r   c                   ó2   — e Zd Zd„ Zd„ Zd„ Zdededefd„Zy)	ÚMPESAPaymentc                 ó    — d | _         d | _        y )N)Úaccess_tokenÚaccess_token_expiry)Úselfs    r$   Ú__init__zMPESAPayment.__init__   s   € Ø ˆÔØ#'ˆÕ r#   c                 óø   — t        j                  «       j                  d«      }t        j                  › t        j
                  › |› }t        j                  |j                  «       «      j                  d«      |fS )z7Generate the M-Pesa password using the provided passkeyz%Y%m%d%H%M%Súutf-8)
r   ÚnowÚstrftimer   r    r   Úbase64Ú	b64encodeÚencodeÚdecode)r*   Ú	timestampÚdata_to_encodes      r$   Úgenerate_passwordzMPESAPayment.generate_password"   se   € ä—L‘L“N×+Ñ+¨NÓ;ˆ	Ü,×@Ñ@ĞAÔBR×BZÑBZĞA[Ğ\eĞ[fĞgˆÜ×Ñ × 5Ñ 5Ó 7Ó8×?Ñ?ÀÓHÈ)ĞSĞSr#   c              ƒ   ó*  K  — | j                   r-t        j                  «       | j                  k  r| j                   S t	        j
                  t        j                  › dt        j                  › j                  «       «      j                  d«      }t        j                  ddd|› i¬«      }|j                  dk7  rt        dd	¬
«      ‚|j                  «       }|d   | _         t        j                  «       t!        d¬«      z   | _        | j                   S ­w)z6Get the access token required to make M-Pesa API callsú:r-   zOhttps://sandbox.safaricom.co.ke/oauth/v1/generate?grant_type=client_credentialsÚAuthorizationzBasic )ÚheaderséÈ   é  zFailed to get access token©Ústatus_codeÚdetailr(   i  )Úseconds)r(   r   r.   r)   r0   r1   r   r   r   r2   r3   ÚrequestsÚgetr>   r   Újsonr   )r*   ÚcredentialsÚresponseÚresults       r$   Úget_access_tokenzMPESAPayment.get_access_token(   sì   è ø€ à×Ò¤§¡£°$×2JÑ2JÒ!JØ×$Ñ$Ğ$ä×&Ñ&Ü×,Ñ,Ğ-¨QÔ/?×/OÑ/OĞ.PĞQ×XÑXÓZó
ç
‰&‹/ğ 	ô —<‘<Ø]Ø$¨¨{¨mĞ&<Ğ=ô
ˆğ
 ×Ñ 3Ò&Ü¨CĞ8TÔUĞUà—‘“ˆØ" >Ñ2ˆÔä#+§<¡<£>´IÀdÔ4KÑ#KˆÔ Ø× Ñ Ğ ùs   ‚DDÚphone_numberÚamountÚ	referencec              ƒ   ó„  K  — | j                  «       ƒ d{  –—† }| j                  «       \  }}d|› ddœ}t        j                  ||dt	        |«      |t        j                  |t        j
                  |d|› dœ}t        j                  d||¬	«      }	|	j                  d
k7  rt        dd¬«      ‚|	j                  «       S 7 Œ§­w)z%Initiate STK push to customer's phoneNzBearer zapplication/json)r9   zContent-TypeÚCustomerPayBillOnlinezWiFi Subscription )ÚBusinessShortCodeÚPasswordÚ	TimestampÚTransactionTypeÚAmountÚPartyAÚPartyBÚPhoneNumberÚCallBackURLÚAccountReferenceÚTransactionDescz?https://sandbox.safaricom.co.ke/mpesa/stkpush/v1/processrequest)rC   r:   r;   r<   zFailed to initiate paymentr=   )rG   r6   r   r    Úintr!   rA   Úpostr>   r   rC   )
r*   rH   rI   rJ   r(   Úpasswordr4   r:   ÚpayloadrE   s
             r$   Úinitiate_stk_pushzMPESAPayment.initiate_stk_push?   sÏ   è ø€ à!×2Ñ2Ó4×4ˆØ"×4Ñ4Ó6Ñˆ)ğ  ' | nĞ5Ø.ñ
ˆô "2×!EÑ!EØ Ø"Ø6Ü˜&“kØ"Ü&×:Ñ:Ø'Ü+×8Ñ8Ø )Ø!3°I°;Ğ?ñ
ˆô —=‘=ØMØØô
ˆğ ×Ñ 3Ò&Ü¨CĞ8TÔUĞUà}‰}‹Ğğ? 5ús   ‚C –B>—B(C N)	r   r   r   r+   r6   rG   ÚstrÚfloatr\   r"   r#   r$   r&   r&      s-   „ ò(òTò!ğ.!°Cğ !Àğ !ĞSVô !r#   r&   z/mpesa/initiaterH   rI   Úsubscription_idÚbackground_tasksc              ƒ   ó²   K  — t        «       }|j                  | |t        |«      ¬«      ƒ d {  –—† }|j                  t        |d   |¬«       d|d   dœS 7 Œ'­w)N)rH   rI   rJ   ÚCheckoutRequestID)Úcheckout_idr_   zPayment initiated)Úmessagerc   )r&   r\   r]   Úadd_taskÚstore_checkout_request)rH   rI   r_   r`   ÚmpesarF   s         r$   Úinitiate_paymentrh   d   ss   è ø€ ô ‹N€EØ×*Ñ*Ø!ØÜoÓ&ğ +ó ÷ €Fğ ×ÑÜØĞ.Ñ/Ø'ğ ô ğ +¸6ĞBUÑ;VÑWĞWğús   ‚+A­A®(Az/mpesa/callbackÚpayment_dataÚdbc              ƒ   óÚ   K  — 	 | d   d   }|d   }|d   dk(  rt        ||«      ƒ d{  –—†  ddiS t        ||«      ƒ d{  –—†  dd	iS 7 Œ 7 Œ
# t        $ r}t        d
d¬«      ‚d}~ww xY w­w)zHandle M-Pesa callbackÚBodyÚstkCallbackrb   Ú
ResultCoder   Nrd   zPayment processed successfullyzPayment failedr<   zInvalid callback datar=   )Úactivate_subscriptionÚmark_payment_failedÚ	Exceptionr   )ri   rj   rF   rc   Úes        r$   Úmpesa_callbackrs   }   s›   è ø€ ğMà˜fÑ% mÑ4ˆØĞ0Ñ1ˆà,Ñ 1Ò$ô (¨°RÓ8×8Ğ8ØĞ?Ğ@Ğ@ô & k°2Ó6×6Ğ6ØĞ/Ğ0Ğ0ğ 9øğ 7ùô ò MÜ¨Ğ4KÔLĞLûğMüsT   ‚A+„$A ¨A	©A °A+±A Á AÁA ÁA+Á	A ÁA Á	A(ÁA#Á#A(Á(A+rc   c              ƒ   ój   K  — t        | |d¬«      }|j                  |«       |j                  «        y­w)zÅWhen initiating an M-Pesa transaction, you will receive a CheckoutRequestID that serves as a unique identifier.
    Store this ID and subscription_id in the database to verify payment status later.ÚPending)rc   r_   ÚstatusN)r	   ÚaddÚcommit)rc   r_   rj   Úpayment_records       r$   rf   rf   •   s2   è ø€ ô #ØØ'Øô€Nğ
 ‡FFˆ>ÔØ‡II…Kùs   ‚13c              ƒ   ó|  K  — |j                  t        «      j                  t        j                  | k(  «      j	                  «       }|rs|j                  t
        «      j                  t
        j                  |j                  k(  «      j	                  «       }|r#d|_        |j                  «        t        d«       yyy­w)z.Activate subscription after successful paymentTzSubscription activatedN©Úqueryr	   Úfilterrc   Úfirstr
   Úidr_   Ú	is_activerx   Úprint©rc   rj   ry   Úsubscriptions       r$   ro   ro   ¢   s‘   è ø€ ğ —X‘XœmÓ,×3Ñ3´M×4MÑ4MĞQ\Ñ4\Ó]×cÑcÓe€Náà—x‘x¤Ó-×4Ñ4´\·_±_È×HfÑHfÑ5fÓg×mÑmÓoˆÙØ%)ˆLÔ"ØI‰IŒKÜĞ*Õ+ğ ğ ùó   ‚B:B<c              ƒ   ó|  K  — |j                  t        «      j                  t        j                  | k(  «      j	                  «       }|rs|j                  t
        «      j                  t
        j                  |j                  k(  «      j	                  «       }|r#d|_        |j                  «        t        d«       yyy­w)z[This function will mark the subscription as inactive or pending in case of payment failure.Fz%Payment failed, subscription inactiveNr{   r‚   s       r$   rp   rp   ±   s‘   è ø€ ğ —X‘XœmÓ,×3Ñ3´M×4MÑ4MĞQ\Ñ4\Ó]×cÑcÓe€Náà—x‘x¤Ó-×4Ñ4´\·_±_È×HfÑHfÑ5fÓg×mÑmÓoˆÙØ%*ˆLÔ"ØI‰IŒKÜĞ9Õ:ğ ğ ùr„   )"Úfastapir   r   r   r   Úfastapi.middleware.corsr   ÚBackend.database.dataBaser   r	   r
   Úpydanticr   Úsqlalchemy.ormr   rA   r0   r   r   rC   ÚappÚadd_middlewarer   r&   rY   r]   r^   rX   rh   Údictrs   rf   ro   rp   r"   r#   r$   ú<module>r      s+  ğß DÓ Dİ 2ß IÑ Iİ İ "Û Û ß (Û áƒi€à × Ñ ØØ%ØØ%Ø%ğ ô ÷>ñ >÷Cñ CğN ‡Ğ
ÓğXØğXàğXğ ğXğ &ò	Xó ğXğ0 ‡Ğ
ÓÙ;BÀ6»?ñ M tğ M°ò Mó ğMğ.	¨cğ 	ÀCğ 	ÈWó 	ğ,¨Sğ ,°gó ,ğ;¨3ğ ;°Gô ;r#   


// File: index.html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safari Connect</title>
    <link rel="stylesheet" href="style.css">
    <link rel="shortcut icon" href="./resources/safari-icon2.svg" type="image/x-icon">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
</head>

<body>
    <div class="container">
        <p style="align-self: center; text-align: center; font-size: medium; font-weight: 300;font-style:italic; font-family: Arial, Helvetica, sans-serif;">
            Explore A Universe Of Possibilities</p>
        <div class="icon-container">
            <img class="safari-icon" src="resources/safari-icon2.svg" alt="safari connect">
        </div>
        <div class="card">
            <h1>Safari Connect</h1>

            <!-- Registration Form -->
            <div id="registerForm">
                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <input type="tel" id="phone" style="text-align: center;" placeholder="Enter your phone number"
                        required>
                </div>
                <button onclick="register()">Register</button>
            </div>

            <!-- OTP Verification Form -->
            <div id="otpForm" class="hidden">
                <div class="form-group">
                    <label for="otp">Enter OTP</label>
                    <input type="text" id="otp" placeholder="Enter OTP code" required>
                </div>
                <button onclick="verifyOTP()">Verify OTP</button>
            </div>

            <!-- Subscription Plans -->
            <div id="plansForm" class="hidden">
                <h2>Choose a Plan</h2>
                <div class="plans">
                    <div class="plan-card" onclick="selectPlan('1hr')">
                        <h3>1 Hour</h3>
                        <p>KSh 10</p>
                    </div>
                    <div class="plan-card" onclick="selectPlan('2hrs')">
                        <h3>2 Hours</h3>
                        <p>KSh 20</p>
                    </div>
                    <div class="plan-card" onclick="selectPlan('3hrs')">
                        <h3>3 Hours</h3>
                        <p>KSh 30</p>
                    </div>
                    <div class="plan-card" onclick="selectPlan('8hrs')">
                        <h3>8 Hours</h3>
                        <p>KSh 80</p>
                    </div>
                    <div class="plan-card" onclick="selectPlan('12hrs')">
                        <h3>12 Hours</h3>
                        <p>KSh 100</p>
                    </div>
                    <div class="plan-card" onclick="selectPlan('24hrs')">
                        <h3>24 Hours</h3>
                        <p>KSh 150</p>
                    </div>
                    <div class="plan-card" onclick="selectPlan('72hrs')">
                        <h3> 3 Days</h3>
                        <p>KSh 250</p>
                    </div>
                    <div class="plan-card" onclick="selectPlan('168hrs')">
                        <h3>1 Week</h3>
                        <p>KSh 350</p>
                    </div>
                    <div class="plan-card" onclick="selectPlan('336hrs')">
                        <h3>2 Weeks</h3>
                        <p>KSh 1050</p>
                    </div>
                    <div class="plan-card" onclick="selectPlan('monthly')">
                        <h3>Monthly</h3>
                        <p>KSh 2000</p>
                    </div>
                </div>
                <button onclick="subscribe()" class="hidden" id="subscribeBtn">Subscribe</button>
            </div>
        </div>
    </div>
    <script src="index.js"></script>
</body>

</html>


// File: index.js
const API_BASE_URL = 'http://192.169.0.102:8000';
let selectedPlan = null;
let currentUser = null;

async function getMacAddress() {
    try {
        const response = await axios.get(`${API_BASE_URL}/mac-address`);
        return response.data.mac_address || "MAC not found";
    } catch (error) {
        console.error("Failed to retrieve MAC address:", error);
        return "Error retrieving MAC";
    }
}

async function register() {
    const phone = document.getElementById('phone').value;
    try {
        const response = await axios.post(`${API_BASE_URL}/register`, {
            phone_number: phone,
            mac_address: await getMacAddress()
        });
        document.getElementById('registerForm').classList.add('hidden');
        document.getElementById('otpForm').classList.remove('hidden');
    } catch (error) {
        showError('Registration failed. Please try again.');
    }
}

async function verifyOTP() {
    const otp = document.getElementById('otp').value;
    const phone = document.getElementById('phone').value;
    try {
        const response = await axios.post(`${API_BASE_URL}/verify-otp`, {
            phone_number: phone,
            otp_code: otp
        });
        
        const token = response.data.token;
        const decodedToken = parseJwt(token);

        if (decodedToken.subscription_active) {
            // User has an active subscription
            showSessionCountdown(decodedToken.time_left);
        } else {
            // No active subscription
            document.getElementById('otpForm').classList.add('hidden');
            document.getElementById('plansForm').classList.remove('hidden');
        }

        currentUser = token;
    } catch (error) {
        showError('Invalid OTP. Please try again.');
    }
}


async function subscribe() {
    if (!selectedPlan || !currentUser) return;
    try {
        const response = await axios.post(`${API_BASE_URL}/subscribe`, {
            plan_type: selectedPlan
        }, {
            headers: { Authorization: `Bearer ${currentUser}` }
        });
        // Handle M-Pesa payment initiation
        showSuccess('Subscription initiated. Please complete payment on your phone.');
    } catch (error) {
        showError('Subscription failed. Please try again.');
    }
}


function selectPlan(plan) {
    selectedPlan = plan;
    document.querySelectorAll('.plan-card').forEach(card => {
        card.classList.remove('selected');
    });
    event.currentTarget.classList.add('selected');
    document.getElementById('subscribeBtn').classList.remove('hidden');
}

function showError(message) {
    const error = document.createElement('div');
    error.className = 'error';
    error.textContent = message;
    document.querySelector('.card').appendChild(error);
    setTimeout(() => error.remove(), 3000);
}

function showSuccess(message) {
    const success = document.createElement('div');
    success.className = 'success';
    success.textContent = message;
    document.querySelector('.card').appendChild(success);
    setTimeout(() => success.remove(), 3000);
}

function parseJwt(token) {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));

    return JSON.parse(jsonPayload);
}

function showSessionCountdown(timeLeft) {
    const countdownContainer = document.createElement('div');
    countdownContainer.className = 'countdown-container';
    document.querySelector('.card').innerHTML = ''; // Clear previous content
    document.querySelector('.card').appendChild(countdownContainer);

    function updateCountdown() {
        if (timeLeft <= 0) {
            clearInterval(countdownInterval);
            countdownContainer.textContent = 'Session expired. Please select a plan.';
            document.getElementById('plansForm').classList.remove('hidden');
            return;
        }

        const hours = Math.floor(timeLeft / 3600);
        const minutes = Math.floor((timeLeft % 3600) / 60);
        const seconds = Math.floor(timeLeft % 60);

        countdownContainer.textContent = `Session time left \n ${hours}h ${minutes}m ${seconds}s`;
        timeLeft--;
    }

    const countdownInterval = setInterval(updateCountdown, 1000);
    updateCountdown();
}



// File: OpenTWRP/dhcp
# /etc/config/dhcp
config dnsmasq
    option domainneeded '1'
    option boguspriv '1'
    option filterwin2k '0'
    option localise_queries '1'
    option rebind_protection '1'
    option rebind_localhost '1'
    option local '/lan/'
    option domain 'lan'
    option expandhosts '1'
    option nonegcache '0'
    option authoritative '1'
    option readethers '1'
    option leasefile '/tmp/dhcp.leases'
    option resolvfile '/tmp/resolv.conf.auto'

config dhcp 'lan'
    option interface 'lan'
    option start '100'
    option limit '150'
    option leasetime '12h'


// File: OpenTWRP/firewll
# Firewall rules (/etc/config/firewall)
# Allow access to captive portal
config rule
    option name 'Allow-Captive-Portal'
    option src 'lan'
    option dest_port '80'
    option proto 'tcp'
    option target 'ACCEPT'

# Block all other traffic for unauthenticated users
config rule
    option name 'Block-Unauthenticated'
    option src 'lan'
    option proto 'all'
    option target 'DROP'


// File: OpenTWRP/network
# /etc/config/network
config interface 'loopback' # type: ignore
    option device 'lo' # type: ignore
    option proto 'static' # type: ignore
    option ipaddr '127.0.0.1' # type: ignore
    option netmask '255.0.0.0' # type: ignore

config interface 'lan' # type: ignore
    option device 'eth0' # type: ignore
    option proto 'static' # type: ignore
    option ipaddr '192.168.1.1' # type: ignore
    option netmask '255.255.255.0' # type: ignore


// File: OpenTWRP/nodogsplash
# /etc/config/nodogsplash
config nodogsplash
    option enabled '1'
    option gatewayname 'WiFi Hotspot'
    option gatewayinterface 'br-lan'
    option maxclients '250'
    option clientidletimeout '1440'
    option webroot '/etc/nodogsplash/htdocs'
    option redirecturl 'http://your-portal-url'
    
# Authentication script
option authenticateimmediately '0'
option passwordattempts '5'
option gatewayiprange '192.168.1.0/24'


// File: style.css
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
}

body {
    background: #f0f2f5;
    color: #1a1a1a;
    line-height: 1.6;
}

.container {
    max-width: 400px;
    margin: 2rem auto;
    padding: 1rem;
}

.card {
    background: white;
    border-radius: 8px;
    padding: 2rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    text-align: center;
}

h1 {
    text-align: center;
    color: #1a73e8;
    margin-bottom: 1.5rem;
}

.form-group {
    margin-bottom: 1rem;
}

label {
    display: block;
    margin-bottom: 0.5rem;
    color: #666;
}

input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
}

button {
    width: 100%;
    padding: 0.75rem;
    background: #1a73e8;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.3s;
}

button:hover {
    background: #1557b0;
}

.plans {
    display: grid;
    gap: 1rem;
    margin-top: 1rem;
}

.plan-card {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.3s;
}

.plan-card:hover {
    border-color: #1a73e8;
    transform: translateY(-2px);
}

.plan-card.selected {
    border-color: #1a73e8;
    background: #f8f9fe;
}

.error {
    color: #d93025;
    margin-top: 0.5rem;
    font-size: 0.875rem;
}

.success {
    color: #188038;
    margin-top: 0.5rem;
    font-size: 0.875rem;
}

.hidden {
    display: none;
}

.icon-container {
    display: flex;
    justify-content: center;
    align-items: center;
    height: fit-content;
}

.safari-icon {
    height: 200px;
}


